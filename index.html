<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RADIO REPLICANTE | Master Sentinel v11.7</title>

    <!-- Engine Core -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;900&family=JetBrains+Mono:wght@700&display=swap');
        :root { --zena-gold: #fbbf24; --bg: #010503; }
        body { background-color: var(--bg); color: #f1f5f9; font-family: 'Outfit', sans-serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--zena-gold); border-radius: 10px; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-marquee { animation: marquee 40s linear infinite; }
        .gold-glow { text-shadow: 0 0 25px rgba(251, 191, 36, 0.5); }
        .monitor-active { border: 10px solid var(--zena-gold); box-shadow: 0 0 80px rgba(251, 191, 36, 0.2); }
        .monitor-off { border: 10px solid rgba(255,255,255,0.05); filter: brightness(0.4) grayscale(1); }
        .scanline { width: 100%; height: 100%; background: linear-gradient(to bottom, transparent 50%, rgba(6, 78, 59, 0.04) 50%); background-size: 100% 4px; position: fixed; pointer-events: none; z-index: 100; opacity: 0.5; }
        .btn-action:active { transform: scale(0.95); }
        .message-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURAZIONE SUPABASE ---
        const supabaseUrl = 'https://cprpshkxzqvtjofjnive.supabase.co';
        const supabaseKey = 'sb_publishable_dcewF1z8L6FW6v8g2WxjwA_YIZcpXPU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "IL_TUO_FIREBASE_API_KEY",
            authDomain: "replicante-b8ab5.firebaseapp.com",
            projectId: "replicante-b8ab5",
            storageBucket: "replicante-b8ab5.appspot.com",
            messagingSenderId: "ID",
            appId: "ID"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'radio-replicante-v11';

        function App() {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [geminiKey, setGeminiKey] = useState('');
            const [misfatti, setMisfatti] = useState([]);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [ugoChat, setUgoChat] = useState([{ role: 'bot', text: "Elvio, v11.7 attiva. Ho saldato i cavi audio. Incolla la Gemini Key (quella che finisce con 3t8) nel Caveau." }]);
            const [isTyping, setIsTyping] = useState(false);
            const [videoOn, setVideoOn] = useState(false);
            const [vaultLocked, setVaultLocked] = useState(true);
            const [status, setStatus] = useState('WAIT_AUTH');
            const videoRef = useRef(null);
            const chatEndRef = useRef(null);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [ugoChat]);

            // Helper Conversione Audio (PCM to WAV)
            const pcmToWav = (pcmData, sampleRate) => {
                const buffer = new ArrayBuffer(44 + pcmData.length);
                const view = new DataView(buffer);
                const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
                writeString(0, 'RIFF'); view.setUint32(4, 36 + pcmData.length, true);
                writeString(8, 'WAVE'); writeString(12, 'fmt ');
                view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true); view.setUint16(34, 16, true);
                writeString(36, 'data'); view.setUint32(40, pcmData.length, true);
                for (let i = 0; i < pcmData.length; i++) view.setUint8(44 + i, pcmData[i]);
                return new Blob([buffer], { type: 'audio/wav' });
            };

            // 1. AUTH & CARICAMENTO CONFIG
            useEffect(() => {
                const init = async () => {
                    try {
                        const u = await auth.signInAnonymously();
                        setUser(u.user);
                    } catch(e) { setStatus('LOCAL_ONLY'); }
                };
                init();

                auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        setStatus('STABLE');
                        try {
                            const docRef = db.collection('artifacts').doc(appId).collection('users').doc(u.uid).collection('settings').doc('config');
                            const snap = await docRef.get();
                            if (snap.exists) setGeminiKey(snap.data().key);
                        } catch(e) { setStatus('DB_LOCKED'); }
                    }
                });
            }, []);

            // 2. SYNC DATI (Supabase)
            useEffect(() => {
                const fetchMugugni = async () => {
                    const { data } = await supabase.from('mugugni').select('*').order('created_at', { ascending: false });
                    if (data) setMisfatti(data);
                };
                fetchMugugni();

                const mugugniSub = supabase.channel('piazza').on('postgres_changes', { event: '*', schema: 'public', table: 'mugugni' }, fetchMugugni).subscribe();
                const vocalSub = supabase.channel('voce').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'vocal_commands' }, p => {
                    if (p.new.testo) saraSpeak(p.new.testo);
                }).subscribe();

                return () => { supabase.removeChannel(mugugniSub); supabase.removeChannel(vocalSub); };
            }, [geminiKey]);

            const saveFuel = async (key) => {
                if (!key) return;
                setStatus('SAVING...');
                setGeminiKey(key);

                // Test immediato dopo inserimento
                saraSpeak("Segnale agganciato. Sono operativa Elvio!");

                if (user) {
                    try {
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('config')
                            .set({ key, updated_at: firebase.firestore.FieldValue.serverTimestamp() });
                        setStatus('FUEL_OK');
                    } catch(e) {
                        console.error(e);
                        setStatus('FUEL_MEM');
                    }
                }
            };

            const askUgo = async (msg) => {
                if (msg.toLowerCase() === 'sbam') { setView('vault'); return; }
                setUgoChat(prev => [...prev, { role: 'user', text: msg }]);
                setIsTyping(true);
                try {
                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: msg }] }],
                            systemInstruction: { parts: [{ text: "Sei Ugo, bot genovese cinico. Rispondi rude, usa 'BelÃ¬n' e insulta potenti e Rolex. Massimo 2 righe." }] }
                        })
                    });
                    const res = await resp.json();
                    if (res.error) throw new Error();
                    const txt = res.candidates[0].content.parts[0].text;
                    setUgoChat(prev => [...prev, { role: 'bot', text: txt }]);
                    saraSpeak(txt);
                } catch (e) {
                    setUgoChat(prev => [...prev, { role: 'bot', text: "BelÃ¬n Elvio, mi manca la chiave o il segnale Ã¨ disturbato! Controlla il Caveau." }]);
                }
                finally { setIsTyping(false); }
            };

            const saraSpeak = async (text) => {
                if (!text || !geminiKey || isSpeaking) return;
                setIsSpeaking(true);
                try {
                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text }] }],
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } }
                        })
                    });
                    const res = await resp.json();
                    if (res.error) throw new Error();

                    const audioBase = res.candidates[0].content.parts[0].inlineData.data;
                    const mimeType = res.candidates[0].content.parts[0].inlineData.mimeType;
                    const rate = parseInt(mimeType.split('rate=')[1]) || 24000;

                    const binary = atob(audioBase);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

                    const audio = new Audio(URL.createObjectURL(pcmToWav(bytes, rate)));
                    audio.onended = () => setIsSpeaking(false);
                    await audio.play();
                } catch (e) {
                    console.error("Audio Error:", e);
                    setIsSpeaking(false);
                }
            };

            const handleLanding = () => {
                setView('hub');
                if (videoRef.current) { videoRef.current.play(); setVideoOn(true); }
            };

            if (view === 'landing') return (
                <div className="min-h-screen bg-black flex items-center justify-center p-6">
                    <div className="max-w-sm w-full glass border-t-8 border-yellow-500 p-12 rounded-[5rem] text-center shadow-2xl animate-in zoom-in">
                        <div className="w-20 h-20 bg-yellow-500 rounded-2xl mx-auto mb-8 flex items-center justify-center font-black text-4xl text-black shadow-lg">R</div>
                        <h1 className="text-4xl font-black italic uppercase text-yellow-500 mb-4 tracking-tighter">SENTINEL 11.7</h1>
                        <p className="text-[10px] text-slate-500 uppercase font-black tracking-[0.5em] mb-10 italic leading-relaxed">Zena Ultra-Stable Unit</p>
                        <button onClick={handleLanding} className="w-full bg-yellow-500 py-6 rounded-3xl font-black uppercase text-xs text-black active:scale-95 transition-all shadow-xl">Sblocca il Segnale</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#010503] text-slate-200 flex flex-col relative overflow-hidden">
                    <header className="px-8 py-5 bg-black/90 border-b border-yellow-500/10 flex justify-between items-center z-50 shadow-2xl">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('hub')}>
                            <div className="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center font-black text-black shadow-lg">R</div>
                            <h1 className="text-xl font-black uppercase italic tracking-tighter">Radio Replicante</h1>
                        </div>
                        <div className="flex gap-4">
                            <span className={`text-[9px] font-black px-4 py-1.5 rounded-full border border-yellow-500/30 uppercase ${geminiKey ? 'text-yellow-500' : 'text-red-500 animate-pulse'}`}>{status}</span>
                            {view !== 'hub' && <button onClick={() => setView('hub')} className="text-[10px] font-black uppercase text-yellow-500 border-b border-yellow-500/20">Moli</button>}
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-6 flex flex-col items-center pb-24 relative z-20">
                        {view === 'hub' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl mt-8 animate-in fade-in">
                                <Card title="Piazza Mugugni" desc="Gogna pubblica operativa." icon="ðŸ˜¤" color="amber" onClick={() => setView('misfatti')} />
                                <Card title="Sara Monitor" desc="L'occhio dei carruggi." icon="ðŸ“¡" color="blue" onClick={() => setView('sara')} />
                                <Card title="Ugo AI" desc="Logica cinica parlante." icon="ðŸ¤–" color="slate" onClick={() => setView('ugo')} />
                                <Card title="Molo Vaticano" desc="Mugugni sotto il campanile." icon="â›ª" color="yellow" onClick={() => setView('vaticano')} />
                                <Card title="Palazzo Tursi" desc="Politica in mutande." icon="ðŸ›ï¸" color="red" onClick={() => setView('politica')} />
                                <Card title="Caveau" desc="Fuel & Gestione Core." icon="ðŸ”’" color="red" onClick={() => setView('vault')} />
                            </div>
                        )}

                        {view === 'ugo' && (
                            <div className="w-full max-w-xl h-[75vh] flex flex-col glass rounded-[4rem] border-2 border-white/5 overflow-hidden shadow-2xl">
                                <div className="flex-1 overflow-y-auto p-8 space-y-6 custom-scrollbar">
                                    {ugoChat.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} message-in`}>
                                            <div className={`max-w-[85%] p-6 rounded-[2.5rem] text-sm font-bold italic uppercase ${m.role === 'user' ? 'bg-yellow-500 text-black shadow-lg' : 'bg-black/60 border border-white/10 text-white shadow-xl'}`}>{m.text}</div>
                                        </div>
                                    ))}
                                    <div ref={chatEndRef} />
                                    {isTyping && <div className="text-[10px] font-black text-yellow-500 animate-pulse uppercase ml-4 italic">Ugo sta masticando...</div>}
                                </div>
                                <div className="p-6 bg-black/60 border-t border-white/5">
                                    <input type="text" placeholder="INSULTA QUALCUNO..." className="w-full bg-slate-800 rounded-3xl px-8 py-5 text-sm font-black uppercase outline-none focus:border-yellow-500 shadow-inner" onKeyDown={e => { if(e.key==='Enter') { askUgo(e.target.value); e.target.value=''; }}} />
                                </div>
                            </div>
                        )}

                        {view === 'sara' && (
                            <div className="flex flex-col items-center gap-12 mt-10 animate-in fade-in">
                                <div className={`relative w-80 h-80 rounded-full overflow-hidden transition-all duration-700 ${isSpeaking ? 'monitor-active scale-105 shadow-2xl' : 'monitor-off scale-100 opacity-60'}`}>
                                    <video ref={videoRef} loop muted playsInline poster="sara.png" className="w-full h-full object-cover scale-110">
                                        <source src="saraaudio.mp4" type="video/mp4"/>
                                    </video>
                                    {isSpeaking && <div className="absolute bottom-12 left-0 w-full flex justify-center gap-2 animate-bounce"><div className="w-2 h-10 bg-yellow-500"></div><div className="w-2 h-14 bg-yellow-500"></div><div className="w-2 h-8 bg-yellow-500"></div></div>}
                                </div>
                                <p className="text-[10px] font-black uppercase tracking-[0.6em] text-yellow-500 animate-pulse italic">Sara is watching the port...</p>
                            </div>
                        )}

                        {view === 'vault' && vaultLocked && (
                            <div className="max-w-sm w-full glass p-12 rounded-[4rem] border-t-8 border-red-600 text-center shadow-2xl mt-10 animate-in zoom-in">
                                <h2 className="text-3xl font-black uppercase italic text-red-600 mb-8 leading-none tracking-tighter">Core Access</h2>
                                <input type="password" placeholder="PASSWORD" className="w-full bg-black border-2 border-white/10 rounded-2xl p-5 text-center text-2xl font-black text-red-500 outline-none mb-6 shadow-inner" onKeyDown={e => { if(e.key==='Enter' && e.target.value.toLowerCase().trim() === 'genova2026') setVaultLocked(false); }} />
                                <p className="text-[9px] text-slate-500 uppercase italic">Suggerimento: L'anno della radio</p>
                            </div>
                        )}

                        {view === 'vault' && !vaultLocked && (
                            <div className="w-full max-w-2xl glass p-12 rounded-[5rem] border-t-8 border-red-600 shadow-2xl space-y-12 text-center animate-in zoom-in-95">
                                <h2 className="text-5xl font-black italic uppercase text-red-600 tracking-tighter leading-none">Il Caveau</h2>
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black text-red-500 uppercase tracking-widest italic">Batteria Vocale (API Gemini Studio):</label>
                                    <input type="password" value={geminiKey} onChange={e => setGeminiKey(e.target.value)} className="w-full bg-black border border-red-900/30 rounded-2xl p-5 text-xl font-mono text-red-500 outline-none focus:border-red-600 shadow-inner" placeholder="INCOLLA QUI..." />
                                    <button onClick={() => saveFuel(geminiKey)} className="w-full bg-red-600 py-6 rounded-3xl font-black uppercase text-[11px] text-white hover:bg-red-500 transition-all shadow-xl active:scale-95">
                                        {status === 'SAVING...' ? 'IN CORSO...' : 'SALDA E ATTIVA'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 gap-4 pt-6 border-t border-white/5">
                                    <button onClick={() => saraSpeak("Test Ultra-Stable. Socio, senti come ruggisce Genova?")} className="bg-white/5 border border-white/10 py-5 rounded-2xl font-black uppercase text-[10px] text-white hover:bg-white/10 transition-all">Spara Test</button>
                                    <button onClick={() => {setView('hub'); setVaultLocked(true);}} className="bg-white/5 border border-white/10 py-5 rounded-2xl font-black uppercase text-[10px] text-slate-400 hover:bg-red-600/10">Esci</button>
                                </div>
                            </div>
                        )}

                        {(view === 'misfatti' || view === 'vaticano' || view === 'politica') && (
                            <div className="w-full max-w-4xl space-y-10 animate-in slide-in-from-bottom-6 pb-20 px-4">
                                <h2 className="text-6xl font-black italic uppercase text-yellow-500 tracking-tighter text-center leading-none">Gogna<br/>Pubblica</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    {misfatti.length === 0 ? <p className="col-span-full text-center opacity-20 font-black uppercase text-4xl py-40 leading-tight">Nessun segnale da Supabase...<br/>Controlla le tabelle!</p> : misfatti.map(m => (
                                        <div key={m.id} className="bg-slate-900/80 p-8 rounded-[4rem] border-l-8 border-red-600 shadow-xl group hover:bg-slate-900 transition-all">
                                            <p className="text-2xl font-black italic uppercase text-white mb-6 leading-tight group-hover:text-yellow-500 transition-colors">"{m.testo}"</p>
                                            {m.foto && <img src={m.foto} className="w-full h-48 object-cover rounded-3xl grayscale group-hover:grayscale-0 transition-all shadow-lg" />}
                                            <div className="mt-6 flex justify-between items-center"><span className="text-[9px] font-black text-red-500 uppercase tracking-widest italic">REC_{m.id}</span></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="h-16 bg-yellow-500 flex items-center overflow-hidden z-50 shadow-2xl border-t-2 border-black/10">
                        <div className="px-12 bg-black h-full flex items-center font-black text-xs text-yellow-500 uppercase italic tracking-[1em]">SENTINEL_11.7</div>
                        <div className="flex-1 whitespace-nowrap animate-marquee flex items-center gap-48 font-black text-lg text-black italic uppercase tracking-tighter">
                            <span>*** RADIO REPLICANTE GENOVA // MASTER HUB v11.7 ULTRA STABLE ***</span>
                            <span>GEMINI_KEY: {geminiKey ? 'ACTIVE' : 'MISSING'} *** SARA: READY ***</span>
                            <span>SALDA LA CHIAVE NEL CAVEAU PER SBLOCCARE L'AUDIO // SBAM! ***</span>
                        </div>
                    </footer>

                    <style dangerouslySetInnerHTML={{ __html: `
                        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
                        .animate-marquee { animation: marquee 40s linear infinite; }
                        ::-webkit-scrollbar { width: 4px; }
                        ::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }
                    `}} />
                </div>
            );
        }

        function Card({ title, desc, icon, onClick, color }) {
            const colors = { amber: 'border-yellow-500/20 hover:border-yellow-500', blue: 'border-blue-500/20 hover:border-blue-500', slate: 'border-slate-500/20 hover:border-slate-500', red: 'border-red-600/20 hover:border-red-600', yellow: 'border-yellow-200/20 hover:border-yellow-200' };
            return (
                <button onClick={onClick} className={`glass border-2 rounded-[4rem] p-10 text-left transition-all hover:bg-slate-900 hover:scale-[1.02] shadow-2xl active:scale-95 ${colors[color] || 'border-white/5'}`}>
                    <div className="text-5xl mb-6 group-hover:scale-110 transition-transform">{icon}</div>
                    <h3 className="text-2xl font-black italic uppercase text-white mb-2 leading-none tracking-tighter">{title}</h3>
                    <p className="text-[10px] text-slate-500 uppercase font-black tracking-widest leading-none mt-2">{desc}</p>
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
